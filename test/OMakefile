
OCAMLPACKS[] += unix extlib threads oUnit

OCAMLFLAGS += -cclib -L$(ROOT)/src/libs/ocaml-leveldb/leveldb \
	      -cclib -L$(ROOT)/src/libs/ocaml-leveldb/src \
	      -cclib -L$(ROOT)/src/core
OCAML_BYTE_LINK_FLAGS =

OCAMLINCLUDES += ../src ../src/libs/ocaml-leveldb/src

OCAML_LIBS[] +=
    ../src/libs/ocaml-leveldb/src/leveldb
    ../src/libs/extprot/runtime/extprot
    ../src/obigstore_core
    ../src/obigstore_server

OCamlProgram(test, $(removesuffix $(ls test_*.ml)) test)
OCamlProgram(benchmark, test_00util benchmark)

toplevel: $(addsuffix .cma, $(OCAML_LIBS))
    ocamlfind ocamlmktop $(mapprefix -package, $(OCAMLPACKS)) \
	-cc g++ -ccopt -Wno-write-strings -thread -linkpkg \
	-verbose -o toplevel -cclib -L. $^

.PHONY: test
test: test.opt
	./test.opt -verbose

.DEFAULT: test$(EXE) benchmark$(EXE)
