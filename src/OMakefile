
OCAMLINCLUDES += libs/ocaml-leveldb/src libs/extprot/runtime

CFLAGS += -g -Wall -O2 -Ilibs/ocaml-leveldb/leveldb/include -fPIC

%.o: %.c
	$(OCAMLC) -cc g++ $(mapprefix -ccopt, $(CFLAGS)) -c $^

CORE_OBJECTS[] =
  backup
  bytea
  crc32c
  data_model
  datum_encoding
  protocol
  protocol_client
  protocol_server
  protocol_payload
  request
  string_util
  weak_ref
  load_stats

SERVER_OBJECTS[] =
  server
  storage

CLIENT_OBJECTS[] =
  ob_util
  repl_common
  repl_gram
  repl_lex

OCamlGeneratedFiles(repl_gram.ml repl_gram.mli repl_lex.ml)

request.ml: request.proto ./libs/extprot/extprotc
	./libs/extprot/extprotc $<

obigstore_stubs.o: obigstore_stubs.cc

section
    OCAMLFLAGS += -for-pack Obigstore_core
    CamlSources($(CORE_OBJECTS)):

section
    OCAMLFLAGS += -for-pack Obigstore_client
    CamlSources($(CLIENT_OBJECTS)):

section
    OCAMLFLAGS += -for-pack Obigstore_server
    CamlSources($(SERVER_OBJECTS)):

OCamlPackage(obigstore_core, $(CORE_OBJECTS))
CamlStubLibrary(obigstore_core, obigstore_core, obigstore_stubs)

OCamlPackage(obigstore_client, $(CLIENT_OBJECTS))
OCamlLibrary(obigstore_client, obigstore_client)

OCamlPackage(obigstore_server, $(SERVER_OBJECTS))
OCamlLibrary(obigstore_server, obigstore_server)

section
    OCAMLPACKS[] += unix extlib threads oUnit
    OCAML_LIBS[] +=
	libs/ocaml-leveldb/src/leveldb
	libs/extprot/runtime/extprot
	obigstore_core
    OCAMLFLAGS += -cclib -L$(ROOT)/src/libs/ocaml-leveldb/leveldb \
		  -cclib -L$(ROOT)/src/libs/ocaml-leveldb/src
    section
	OCAML_LIBS[] += obigstore_client
	OCamlProgram(ob_dump, ob_dump)
	OCamlProgram(ob_load, ob_load)
	OCamlProgram(ob_repl, ob_repl)

    section
        OCAML_LIBS[] += obigstore_server
	OCamlProgram(obigstore, run_server)

    toplevel: libs/ocaml-leveldb/src/leveldb.cma \
	      libs/extprot/runtime/extprot.cma \
	      obigstore_core.cma \
	      obigstore_server.cma
	    ocamlfind ocamlmktop \
		$(mapprefix -package, $(OCAMLPACKS)) \
		-cc g++ -verbose -o toplevel \
		-cclib -L. \
		-cclib -Llibs/ocaml-leveldb/src \
		libs/ocaml-leveldb/src/leveldb.cma \
		libs/extprot/runtime/extprot.cma \
		obigstore_core.cma \
		obigstore_server.cma \
		-linkpkg -thread

.DEFAULT: obigstore$(EXE) ob_dump$(EXE) ob_load$(EXE) ob_repl$(EXE)


