
OCAMLINCLUDES += libs/ocaml-leveldb/src libs/extprot/runtime

CFLAGS += -g -Wall -O2 -Ilibs/ocaml-leveldb/leveldb/include -fPIC

%.o: %.c
	$(OCAMLC) -cc g++ $(mapprefix -ccopt, $(CFLAGS)) -c $^

OBJECTS[] =
  bytea
  crc32c
  data_model
  datum_key
  protocol
  protocol_server
  protocol_payload
  storage
  string_util

request.ml: request.proto
	./libs/extprot/extprotc $<

ostore_stubs.o: ostore_stubs.cc

ostore.cma ostore.a ostore.cmxa: ostore_stubs.o \
    $(addsuffixes .cmo .cmx, $(OBJECTS))
	ocamlmklib -verbose -oc camlostore -o ostore \
	    ostore_stubs.o \
	    $(OCamlLinkSort $(addsuffixes .cmo, $(OBJECTS))) \
	    $(OCamlLinkSort $(addsuffixes .cmx, $(OBJECTS)))

toplevel: ostore.cma libs/ocaml-leveldb/src/leveldb.cma
	ocamlfind ocamlmktop \
	    $(mapprefix -package, $(OCAMLPACKS)) \
	    -cc g++ -verbose -o toplevel \
	    -cclib -L. \
	    -cclib -Llibs/ocaml-leveldb/src \
	    libs/ocaml-leveldb/src/leveldb.cma ostore.cma \
	    -linkpkg

.DEFAULT: ostore.cma ostore.cmxa


