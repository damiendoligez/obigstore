
OCAMLINCLUDES += libs/ocaml-leveldb/src libs/extprot/runtime

CFLAGS += -g -Wall -O2 -Ilibs/ocaml-leveldb/leveldb/include -fPIC

%.o: %.c
	$(OCAMLC) -cc g++ $(mapprefix -ccopt, $(CFLAGS)) -c $^

OBJECTS[] =
  backup
  bytea
  crc32c
  data_model
  datum_encoding
  ob_util
  protocol
  protocol_client
  protocol_server
  protocol_payload
  request
  storage
  string_util

request.ml: request.proto
	./libs/extprot/extprotc $<

ostore_stubs.o: ostore_stubs.cc

ostore.cma ostore.a ostore.cmxa: ostore_stubs.o \
    $(addsuffixes .cmo .cmx, $(OBJECTS))
	ocamlmklib -verbose -oc camlostore -o ostore \
	    ostore_stubs.o \
	    $(OCamlLinkSort $(addsuffixes .cmo, $(OBJECTS))) \
	    $(OCamlLinkSort $(addsuffixes .cmx, $(OBJECTS)))

OCamlLibrary(ostore_server, server)

section
    OCAMLPACKS[] += unix extlib threads oUnit
    OCAML_LIBS[] +=
	libs/ocaml-leveldb/src/leveldb
	libs/extprot/runtime/extprot
	ostore
	ostore_server
    OCAMLFLAGS += -cclib -L$(ROOT)/src/libs/ocaml-leveldb/leveldb \
		  -cclib -L$(ROOT)/src/libs/ocaml-leveldb/src
    OCamlProgram(obigstore, run_server)
    OCamlProgram(ob_dump, ob_dump)
    OCamlProgram(ob_load, ob_load)

toplevel: ostore.cma libs/ocaml-leveldb/src/leveldb.cma
	ocamlfind ocamlmktop \
	    $(mapprefix -package, $(OCAMLPACKS)) \
	    -cc g++ -verbose -o toplevel \
	    -cclib -L. \
	    -cclib -Llibs/ocaml-leveldb/src \
	    libs/ocaml-leveldb/src/leveldb.cma ostore.cma \
	    -linkpkg

.DEFAULT: obigstore$(EXE) ob_dump$(EXE) ob_load$(EXE)


