
OCAMLINCLUDES += libs/ocaml-leveldb/src libs/extprot/runtime

CFLAGS += -g -Wall -O2 -Ilibs/ocaml-leveldb/leveldb/include -fPIC

%.o: %.c
	$(OCAMLC) -cc g++ $(mapprefix -ccopt, $(CFLAGS)) -c $^

OBJECTS[] =
  backup
  bytea
  crc32c
  data_model
  datum_encoding
  ob_util
  protocol
  protocol_client
  protocol_server
  protocol_payload
  repl_common
  repl_gram
  repl_lex
  ob_repl
  request
  storage
  string_util

OCamlGeneratedFiles(repl_gram.ml repl_gram.mli repl_lex.ml)

request.ml: request.proto ./libs/extprot/extprotc
	./libs/extprot/extprotc $<

obigstore_stubs.o: obigstore_stubs.cc

obigstore.cma obigstore.a obigstore.cmxa: obigstore_stubs.o \
    $(addsuffixes .cmo .cmx, $(OBJECTS))
	ocamlmklib -verbose -oc camlobigstore -o obigstore \
	    obigstore_stubs.o \
	    $(OCamlLinkSort $(addsuffixes .cmo, $(OBJECTS))) \
	    $(OCamlLinkSort $(addsuffixes .cmx, $(OBJECTS)))

OCamlLibrary(obigstore_server, server)

section
    OCAMLPACKS[] += unix extlib threads oUnit
    OCAML_LIBS[] +=
	libs/ocaml-leveldb/src/leveldb
	libs/extprot/runtime/extprot
	obigstore
	obigstore_server
    OCAMLFLAGS += -cclib -L$(ROOT)/src/libs/ocaml-leveldb/leveldb \
		  -cclib -L$(ROOT)/src/libs/ocaml-leveldb/src
    OCamlProgram(obigstore, run_server)
    OCamlProgram(ob_dump, ob_dump)
    OCamlProgram(ob_load, ob_load)
    OCamlProgram(ob_repl, ob_repl)

    toplevel: libs/ocaml-leveldb/src/leveldb.cma \
	      libs/extprot/runtime/extprot.cma \
	      obigstore.cma
	    ocamlfind ocamlmktop \
		$(mapprefix -package, $(OCAMLPACKS)) \
		-cc g++ -verbose -o toplevel \
		-cclib -L. \
		-cclib -Llibs/ocaml-leveldb/src \
		libs/ocaml-leveldb/src/leveldb.cma \
		libs/extprot/runtime/extprot.cma \
		obigstore.cma \
		-linkpkg -thread

.DEFAULT: obigstore$(EXE) ob_dump$(EXE) ob_load$(EXE) ob_repl$(EXE)


