
USE_OCAMLFIND = true
NATIVE_ENABLED = true
BYTE_ENABLED = true

.PHONY: clean

OCAMLOPTFLAGS += -g -inline 100

.SUBDIRS: src/libs/ocaml-leveldb src/libs/extprot

OCAMLCFLAGS += -g
OCAMLFLAGS += -annot -thread
OCAMLFINDFLAGS += -syntax camlp4o

OCAMLPACKS[] = batteries cryptokit lwt lwt.unix lwt.syntax lwt.preemptive lwt.text

LD_PATHS[] =
	$(file src/libs/ocaml-leveldb/leveldb)
	$(file src/libs/ocaml-leveldb/src)
	$(file src)
	$(file src/core)

setenv(CAML_LD_LIBRARY_PATH, $(concat :, $(absname $(LD_PATHS))))

public.CamlStubLibrary(dst, objects, stubs) =
    private.stub_objects = $(addsuffix .o, $(stubs))
    $(dst).cma $(dst).a $(dst).cmxa: \
	$(stub_objects) $(addsuffixes .cmo .cmx, $(objects))
        ocamlmklib -verbose -oc caml$(dst) -o $(dst) \
	    $(stub_objects) \
	    $(OCamlLinkSort $(addsuffixes .cmo, $(objects))) \
	    $(OCamlLinkSort $(addsuffixes .cmx, $(objects)))

CamlSources(mods) =
        foreach(mod, $(mods))
                $(addsuffixes .cmo .cmi .cmx .sig $(EXT_OBJ), $(mod)):

.SUBDIRS: src test

foreach(exec, obigstore ob_dump ob_load ob_repl)
    $(exec): src/$(exec)$(EXE)
        ln-or-cp $< $@

.DEFAULT: obigstore ob_dump ob_load ob_repl

clean:
	rm -f $(filter-proper-targets $(ls R, .))
